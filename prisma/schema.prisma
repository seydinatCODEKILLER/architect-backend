// schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// --------------------
// Enums
// --------------------
enum Visibility {
  Private
  Unlisted    
  Public      
}

enum DiagramType {
  Flowchart
  Sequence
  Class
  ER
  State
  Gantt
  Pie
  Timeline
  Quadrant
  Mindmap
}

enum ADRStatus {
  Draft
  Proposed
  Accepted
  Implemented
  Superseded
  Deprecated
  Rejected
}

enum ActivityAction {
  ARCHITECTURE_CREATE
  ARCHITECTURE_UPDATE
  ARCHITECTURE_DELETE
  ARCHITECTURE_CLONE
  ARCHITECTURE_PUBLISH
  ARCHITECTURE_UNPUBLISH
  DIAGRAM_CREATE
  DIAGRAM_UPDATE
  DIAGRAM_DELETE
  ADR_CREATE
  ADR_UPDATE
  ADR_STATUS_CHANGE
  FILETREE_UPDATE
  DOCUMENTATION_UPDATE
  ARCHITECTURE_VIEW
}

enum InvitationStatus {
  Pending
  Accepted
  Declined
  Expired
  Revoked
}

// --------------------
// Utilisateur
// --------------------
model User {
  id              String         @id @default(cuid())
  email           String         @unique
  emailVerified   Boolean        @default(false)
  
  // Nom complet
  firstName       String?
  lastName        String?
  displayName     String?
  
  // Avatar
  avatarUrl       String?
  
  // Métadonnées d'authentification
  authProvider    String?        
  authProviderId  String?        
  
  // Relations
  architectures   Architecture[]
  userSettings    UserSettings?
  uploadedFiles   UploadedFile[]
  activityLogs    ActivityLog[]
  proposedADRs    ArchitectureDecisionRecord[] @relation("ProposedADRs")
  reviewedADRs    ArchitectureDecisionRecord[] @relation("ReviewedADRs")
  receivedCloneInvitations CloneInvitation[] @relation("InvitedUser")
  comments        Comment[]
  stars           Star[]
  session         Session[]
  
  // Timestamps
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  lastLoginAt     DateTime?

  @@map("users")
  @@index([authProvider, authProviderId])
  @@index([email])
}

// --------------------
// Paramètres utilisateur
// --------------------
model UserSettings {
  id                String   @id @default(cuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Préférences d'interface
  theme             String   @default("system")  
  editorFontSize    Int      @default(14)
  editorTheme       String   @default("vs-dark")
  language          String   @default("fr")      
  
  // Préférences de travail
  autoSave          Boolean  @default(true)
  saveInterval      Int      @default(5000)
  defaultView       String   @default("editor") 
  
  // Notifications
  emailNotifications Boolean @default(true)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("user_settings")
}

// --------------------
// Architecture principale
// --------------------
model Architecture {
  id              String        @id @default(cuid())
  slug            String        @unique
  title           String
  description     String?
  
  // Visibilité
  visibility      Visibility    @default(Private)
  
  // Stack et tags (tableaux PostgreSQL)
  techStack       String[]
  tags            String[]
  
  // Contexte et objectifs
  projectContext  String?
  objectives      String?
  
  // Stats
  views           Int           @default(0)
  clones          Int           @default(0)
  likes           Int           @default(0)
  
  // Contenu principal (JSON pour PostgreSQL)
  fileTree        Json?         
  documentation   String?       
  
  // Métadonnées
  isTemplate      Boolean       @default(false)
  license         String?       @default("MIT")
  
  // Relations
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Sous-éléments
  diagrams        Diagram[]
  adrs            ArchitectureDecisionRecord[]
  comments        Comment[]
  activityLogs    ActivityLog[]
  uploadedFiles   UploadedFile[]
  stars           Star[]
  sourceCloneInvitations  CloneInvitation[] @relation("source_clones")
  targetCloneInvitations  CloneInvitation[] @relation("target_clones")
  
  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  lastEditedAt    DateTime      @default(now())
  publishedAt     DateTime?

  @@map("architectures")
  @@index([userId])
  @@index([visibility])
  @@index([createdAt])
  @@index([slug])
  @@index([tags])
}

// --------------------
// Diagrammes Mermaid
// --------------------
model Diagram {
  id              String        @id @default(cuid())
  architectureId  String
  architecture    Architecture  @relation(fields: [architectureId], references: [id], onDelete: Cascade)
  
  title           String
  description     String?
  
  type            DiagramType   @default(Flowchart)
  mermaidCode     String
  config          Json?         
  
  // Relations
  comments        Comment[]     

  // Métadonnées
  position        Int           @default(0)     
  width           Int           @default(800)
  height          Int           @default(600)
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("diagrams")
  @@index([architectureId])
  @@index([type])
  @@index([position])
}

// --------------------
// Architecture Decision Records (ADR)
// --------------------
model ArchitectureDecisionRecord {
  id              String        @id @default(cuid())
  architectureId  String
  architecture    Architecture  @relation(fields: [architectureId], references: [id], onDelete: Cascade)
  
  title           String
  status          ADRStatus     @default(Proposed)
  
  // Contenu structuré
  context         String
  decisionDrivers String?       
  consideredOptions String?     
  decision        String
  consequences    String
  implementationNotes String?   
  
  // Métadonnées
  number          Int           
  supersededById  String?       
  
  // Participants
  proposedById    String?
  proposedBy      User?         @relation("ProposedADRs", fields: [proposedById], references: [id])
  reviewedById    String?
  reviewedBy      User?         @relation("ReviewedADRs", fields: [reviewedById], references: [id])

  // Comments
  comments        Comment[]
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  decisionDate    DateTime?

  @@map("adrs")
  @@index([architectureId])
  @@unique([architectureId, number])
  @@index([status])
  @@index([proposedById])
  @@index([number])
}

// --------------------
// Fichiers uploadés
// --------------------
model UploadedFile {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  architectureId  String?
  architecture    Architecture? @relation(fields: [architectureId], references: [id], onDelete: Cascade)
  
  // Infos fichier
  filename        String
  originalName    String
  mimeType        String
  size            Int           
  key             String        @unique 
  
  // Métadonnées
  description     String?
  tags            String[]
  
  // URLs
  url             String        
  thumbnailUrl    String?       
  
  // Visibilité
  visibility      Visibility    @default(Private)
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("uploaded_files")
  @@index([userId])
  @@index([architectureId])
  @@index([visibility])
  @@index([mimeType])
  @@index([createdAt])
}

// --------------------
// Historique des actions
// --------------------
model ActivityLog {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  architectureId  String?
  architecture    Architecture? @relation(fields: [architectureId], references: [id], onDelete: Cascade)
  
  // Action
  action          ActivityAction
  entityType      String        
  entityId        String?
  
  // Données supplémentaires
  details         Json?         
  message         String?
  ipAddress       String?
  
  createdAt       DateTime      @default(now())

  @@map("activity_logs")
  @@index([userId])
  @@index([architectureId])
  @@index([createdAt])
  @@index([action])
  @@index([entityType, entityId])
}

// --------------------
// Invitations / Clonage
// --------------------
model CloneInvitation {
  id              String        @id @default(cuid())
  sourceArchitectureId String
  sourceArchitecture Architecture @relation("source_clones", fields: [sourceArchitectureId], references: [id], onDelete: Cascade)
  
  targetArchitectureId String?
  targetArchitecture Architecture? @relation("target_clones", fields: [targetArchitectureId], references: [id], onDelete: Cascade)
  
  invitedUserId   String?
  invitedUser     User?         @relation("InvitedUser", fields: [invitedUserId], references: [id], onDelete: SetNull)
  
  invitedEmail    String?
  token           String        @unique
  
  status          InvitationStatus @default(Pending)
  
  expiresAt       DateTime
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("clone_invitations")
  @@index([sourceArchitectureId])
  @@index([invitedEmail])
  @@index([token])
  @@index([expiresAt])
  @@index([status])
  @@index([createdAt])
}

// --------------------
// Commentaires
// --------------------
model Comment {
  id              String        @id @default(cuid())
  content         String
  
  // Threading
  parentId        String?
  parent          Comment?      @relation("CommentReplies", fields: [parentId], references: [id])
  replies         Comment[]     @relation("CommentReplies")
  
  // Cible
  architectureId  String?
  architecture    Architecture? @relation(fields: [architectureId], references: [id], onDelete: Cascade)
  
  diagramId       String?
  diagram         Diagram?      @relation(fields: [diagramId], references: [id], onDelete: Cascade)
  
  adrId           String?
  adr             ArchitectureDecisionRecord? @relation(fields: [adrId], references: [id], onDelete: Cascade)
  
  // Auteur
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Métadonnées
  isEdited        Boolean       @default(false)
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("comments")
  @@index([architectureId])
  @@index([userId])
  @@index([createdAt])
  @@index([parentId])
  @@index([diagramId])
  @@index([adrId])
}

// --------------------
// Stars / Favoris
// --------------------
model Star {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  architectureId  String
  architecture    Architecture  @relation(fields: [architectureId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime      @default(now())

  @@map("stars")
  @@unique([userId, architectureId])
  @@index([architectureId])
  @@index([userId])
  @@index([createdAt])
}

// --------------------
// Sessions (pour Better-Auth)
// --------------------
model Session {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  token           String        @unique
  userAgent       String?
  ipAddress       String?
  
  expiresAt       DateTime
  createdAt       DateTime      @default(now())

  @@map("sessions")
  @@index([userId])
  @@index([expiresAt])
  @@index([token])
}
